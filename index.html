<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Organograma Estratégico Interativo - Young</title>
  <script type="module" src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script type="module" src="https://www.gstatic.com/charts/loader.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
    }
    #chart_div {
      width: 100%;
      height: 90vh;
    }
    .tooltip {
      font-size: 12px;
    }
    .modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #fff;
      padding: 20px;
      border: 1px solid #ccc;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      z-index: 1000;
      display: none;
    }
    .modal.active {
      display: block;
    }
    .modal textarea, .modal input {
      width: 100%;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <h1 style="text-align: center">Organograma Estratégico Interativo - Young Empreendimentos</h1>
  <div id="chart_div"></div>
  <div id="aiModal" class="modal">
    <div id="aiAnalysis"></div>
    <textarea id="aiFollowUp" placeholder="Pergunte mais sobre este indicador..."></textarea>
    <button onclick="sendFollowUp()">Enviar</button>
  </div>
  <script>
    const SHEET_ID = '1H-9oU9Q1HxO2iASPY24hvxK2ZWZBOHFMLuu8KLPRKCw';
    const SHEET_NAME = 'Organograma';
    const MONTH_YEAR = new Date().toLocaleString('pt-BR', { month: 'long', year: 'numeric' }).toLowerCase();
    const endpoint = `https://opensheet.elk.sh/${SHEET_ID}/${SHEET_NAME}`;

    let chart;
    let aiContext = '';

    google.charts.load('current', { packages: ['orgchart'] });
    google.charts.setOnLoadCallback(drawChart);

    async function drawChart() {
      const response = await fetch(endpoint);
      const data = await response.json();

      const filtered = data.filter(row => (row['Mês'] || '').toLowerCase() === MONTH_YEAR);

      const treeData = new google.visualization.DataTable();
      treeData.addColumn('string', 'Name');
      treeData.addColumn('string', 'Manager');
      treeData.addColumn('string', 'ToolTip');

      treeData.addRows(filtered.map(row => {
        let content = `<div style='padding:5px;'><strong>${row['Indicador']}</strong><br/>Nível: ${row['Nível']}<br/>Resultado: ${row['Resultado']} / Meta: ${row['Meta']}</div>`;
        let color = 'lightgray';

        if (row['Resultado'] && row['Meta']) {
          const resultado = parseFloat(row['Resultado'].replace(',', '.'));
          const meta = parseFloat(row['Meta'].replace(',', '.'));
          if (!isNaN(resultado) && !isNaN(meta)) {
            color = resultado >= meta ? 'lightgreen' : '#f77';
          }
        }

        const html = `
          <div style='border:1px solid #ccc;padding:5px;background:${color};'>
            <div>${row['Indicador'] || row['Objetivo'] || row['Empresa']}</div>
            <div style='font-size: 11px;'>Nível: ${row['Nível'] || '---'}</div>
            <div style='font-size: 11px;'>Resultado: ${row['Resultado'] || '-'} / Meta: ${row['Meta'] || '-'}</div>
            ${row['Meta'] && row['Resultado'] ? `<div><span onclick="openAIModal('${row['Indicador']}')">✨</span></div>` : ''}
          </div>
        `;
        return [
          { v: row['Indicador'] || row['Objetivo'] || row['Empresa'], f: html },
          row['Superior'] || '',
          `Time: ${row['Time'] || '-'}\nNível: ${row['Nível'] || '-'}`
        ];
      }));

      chart = new google.visualization.OrgChart(document.getElementById('chart_div'));
      chart.draw(treeData, { allowHtml: true, nodeClass: 'node-style' });
    }

    function openAIModal(indicador) {
      aiContext = indicador;
      document.getElementById('aiModal').classList.add('active');
      document.getElementById('aiAnalysis').innerHTML = `<p>Analisando o indicador <strong>${indicador}</strong>...</p>`;
      fetchGeminiAnalysis(indicador);
    }

    async function fetchGeminiAnalysis(indicador) {
      // Simulação de IA, substitua por chamada real a API Gemini
      const analysis = `Análise gerada pela IA para o indicador "${indicador}". Desempenho dentro do esperado. Plano de ação: manter as práticas atuais e revisar mensalmente.`;
      document.getElementById('aiAnalysis').innerHTML = `<p>${analysis}</p>`;
    }

    function sendFollowUp() {
      const question = document.getElementById('aiFollowUp').value;
      if (!question.trim()) return;
      // Simulação de resposta da IA
      const followUpResponse = `<p><strong>Você:</strong> ${question}</p><p><strong>IA:</strong> Aprofundando a análise do indicador "${aiContext}", sugere-se observar variações sazonais e engajar o time nas metas do próximo trimestre.</p>`;
      document.getElementById('aiAnalysis').innerHTML += followUpResponse;
      document.getElementById('aiFollowUp').value = '';
    }
  </script>
</body>
</html>
