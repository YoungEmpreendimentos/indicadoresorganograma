import React, { useEffect, useRef, useState } from "react";
import * as d3 from "d3";
import { Card } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import html2canvas from "html2canvas";
import saveSvgAsPng from "save-svg-as-png";

interface Objetivo {
  Empresa: string;
  Objetivo: string;
  Indicador: string;
  Meta: number;
  Resultado: number;
  Time: string;
  Data: string;
}

interface Node extends d3.HierarchyPointNode<any> {
  data: any;
  children?: Node[];
}

export default function ObjetivosTree({ data }: { data: Objetivo[] }) {
  const svgRef = useRef<SVGSVGElement | null>(null);
  const wrapperRef = useRef<HTMLDivElement | null>(null);

  const [selectedMonth, setSelectedMonth] = useState<string>("Todos");
  const [selectedTeam, setSelectedTeam] = useState<string>("Todos");
  const [onlyNotMet, setOnlyNotMet] = useState<boolean>(false);

  const months = Array.from(
    new Set(
      data.map((d) => {
        const date = new Date(d.Data);
        return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, "0")}`;
      })
    )
  );

  const teams = Array.from(new Set(data.map((d) => d.Time)));

  const filteredData = data.filter((d) => {
    const date = new Date(d.Data);
    const dateKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, "0")}`;
    const byMonth = selectedMonth === "Todos" || dateKey === selectedMonth;
    const byTeam = selectedTeam === "Todos" || d.Time === selectedTeam;
    const byResult = !onlyNotMet || d.Resultado < d.Meta;
    return byMonth && byTeam && byResult;
  });

  useEffect(() => {
    if (!svgRef.current || !filteredData.length) return;

    const svg = d3.select(svgRef.current);
    svg.selectAll("*").remove();

    const width = wrapperRef.current?.clientWidth || 1000;
    const dx = 120;
    const dy = 280;
    const margin = { top: 60, right: 80, bottom: 60, left: 80 };
    const height = 800;

    const root = d3.stratify<Objetivo>()
      .id((d) => `${d.Empresa}/${d.Objetivo}/${d.Indicador}`)
      .parentId((d) => {
        if (d.Indicador) return `${d.Empresa}/${d.Objetivo}`;
        if (d.Objetivo) return `${d.Empresa}`;
        return "";
      })(filteredData);

    const treeLayout = d3.tree().nodeSize([dx, dy]);
    const hierarchy = d3.hierarchy(root as any);
    const tree = treeLayout(hierarchy);

    const g = svg
      .attr("viewBox", [-margin.left, -margin.top, width, height])
      .append("g")
      .attr("transform", `translate(${margin.left},${margin.top})`);

    const link = g
      .append("g")
      .attr("fill", "none")
      .attr("stroke", "#ccc")
      .attr("stroke-width", 2)
      .selectAll("path")
      .data(tree.links())
      .join("path")
      .attr("d", d3.linkHorizontal()
        .x((d) => d.y as number)
        .y((d) => d.x as number)
      );

    const node = g
      .append("g")
      .selectAll("g")
      .data(tree.descendants())
      .join("g")
      .attr("transform", (d) => `translate(${d.y},${d.x})`);

    node.append("rect")
      .attr("x", -80)
      .attr("y", -20)
      .attr("width", 160)
      .attr("height", 40)
      .attr("rx", 8)
      .attr("fill", (d) => {
        if (!d.data.data.Indicador) return "#f3f4f6";
        return d.data.data.Resultado < d.data.data.Meta ? "#fecaca" : "#bbf7d0";
      })
      .attr("stroke", "#000");

    node.append("text")
      .attr("dy", "0.35em")
      .attr("text-anchor", "middle")
      .text((d) => {
        if (d.data.data.Indicador) {
          return `${d.data.data.Indicador}: ${d.data.data.Resultado}/${d.data.data.Meta}`;
        } else if (d.data.data.Objetivo) {
          return d.data.data.Objetivo;
        } else {
          return d.data.data.Empresa;
        }
      })
      .style("font-size", "12px");
  }, [filteredData]);

  const exportAsPng = () => {
    if (!wrapperRef.current) return;
    html2canvas(wrapperRef.current).then((canvas) => {
      const link = document.createElement("a");
      link.download = "objetivos-tree.png";
      link.href = canvas.toDataURL();
      link.click();
    });
  };

  const exportAsSvg = () => {
    if (!svgRef.current) return;
    saveSvgAsPng.saveSvgAsPng(svgRef.current, "objetivos-tree.svg");
  };

  return (
    <div className="space-y-4">
      <div className="flex gap-2">
        <select value={selectedMonth} onChange={(e) => setSelectedMonth(e.target.value)} className="border p-1 rounded">
          <option value="Todos">Todos os Meses</option>
          {months.map((month) => (
            <option key={month} value={month}>{month}</option>
          ))}
        </select>

        <select value={selectedTeam} onChange={(e) => setSelectedTeam(e.target.value)} className="border p-1 rounded">
          <option value="Todos">Todos os Times</option>
          {teams.map((team) => (
            <option key={team} value={team}>{team}</option>
          ))}
        </select>

        <label className="flex items-center gap-1">
          <input type="checkbox" checked={onlyNotMet} onChange={(e) => setOnlyNotMet(e.target.checked)} /> Somente n√£o atingidos
        </label>

        <Button onClick={exportAsPng}>Exportar PNG</Button>
        <Button onClick={exportAsSvg}>Exportar SVG</Button>
      </div>

      <Card>
        <div ref={wrapperRef} className="overflow-auto">
          <svg ref={svgRef} width="1000" height="800" />
        </div>
      </Card>

      <div id="tooltip" style={{ position: "absolute", background: "white", padding: "8px", border: "1px solid #ccc", borderRadius: "4px", opacity: 0, pointerEvents: "none" }}></div>
    </div>
  );
}
